#!/bin/bash

# Walrus LinkTree - Deployment Script
# Bu script Move sÃ¶zleÅŸmesini testnet'e deploy eder

set -e

echo "ðŸš€ Walrus LinkTree Deployment BaÅŸlÄ±yor..."
echo ""

# Renk kodlarÄ±
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# 1. Gas kontrolÃ¼
echo "1ï¸âƒ£  Gas durumu kontrol ediliyor..."
GAS_OUTPUT=$(sui client gas 2>&1)
if [[ "$GAS_OUTPUT" == *"No gas coins"* ]]; then
    echo -e "${RED}âŒ Gas coin yok!${NC}"
    echo ""
    echo "LÃ¼tfen faucet'ten SUI alÄ±n:"
    echo "  Discord: https://discord.gg/sui â†’ #testnet-faucet"
    echo "  !faucet $(sui client active-address)"
    echo ""
    echo "  Web: https://suifaucet.com/"
    echo ""
    exit 1
fi
echo -e "${GREEN}âœ… Gas mevcut${NC}"
echo ""

# 2. Move build
echo "2ï¸âƒ£  Move sÃ¶zleÅŸmesi build ediliyor..."
cd move
sui move build
if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Build baÅŸarÄ±sÄ±z!${NC}"
    exit 1
fi
echo -e "${GREEN}âœ… Build baÅŸarÄ±lÄ±${NC}"
echo ""

# 3. Test
echo "3ï¸âƒ£  Testler Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
sui move test
if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Testler baÅŸarÄ±sÄ±z!${NC}"
    exit 1
fi
echo -e "${GREEN}âœ… Testler geÃ§ti${NC}"
echo ""

# 4. Deploy
echo "4ï¸âƒ£  Testnet'e deploy ediliyor..."
echo -e "${YELLOW}â³ Bu iÅŸlem 10-30 saniye sÃ¼rebilir...${NC}"
DEPLOY_OUTPUT=$(sui client publish --gas-budget 100000000 --json 2>&1)

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Deploy baÅŸarÄ±sÄ±z!${NC}"
    echo "$DEPLOY_OUTPUT"
    exit 1
fi

echo -e "${GREEN}âœ… Deploy baÅŸarÄ±lÄ±!${NC}"
echo ""

# 5. Package ID'yi parse et
PACKAGE_ID=$(echo "$DEPLOY_OUTPUT" | grep -oP '"packageId"\s*:\s*"\K[^"]+' | head -1)
echo "ðŸ“¦ Package ID: $PACKAGE_ID"

# 6. Registry Object ID'yi bul (SharedObjects iÃ§inden)
REGISTRY_ID=$(echo "$DEPLOY_OUTPUT" | grep -oP '"objectId"\s*:\s*"\K[^"]+' | grep -v "$PACKAGE_ID" | head -1)
echo "ðŸ“‹ Registry ID: $REGISTRY_ID"

# 7. .env dosyasÄ± oluÅŸtur
cd ../frontend
cat > .env << EOF
# Auto-generated by deploy script - $(date)
VITE_NETWORK=testnet
VITE_RPC_URL=https://fullnode.testnet.sui.io:443
VITE_PACKAGE_ID=$PACKAGE_ID
VITE_REGISTRY_ID=$REGISTRY_ID
VITE_WALRUS_PORTAL=trwal.app
VITE_IPFS_GATEWAY=https://ipfs.io/ipfs/
EOF

echo ""
echo -e "${GREEN}âœ… .env dosyasÄ± oluÅŸturuldu${NC}"
echo ""

# 8. Ã–zet
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸŽ‰ DEPLOYMENT BAÅžARILI!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ðŸ“ Ã–nemli Bilgiler:"
echo "  Package ID:  $PACKAGE_ID"
echo "  Registry ID: $REGISTRY_ID"
echo "  Network:     testnet"
echo ""
echo "ðŸ”— Explorer Links:"
echo "  Package: https://suiscan.xyz/testnet/object/$PACKAGE_ID"
echo "  Registry: https://suiscan.xyz/testnet/object/$REGISTRY_ID"
echo ""
echo "ðŸ“‹ Sonraki AdÄ±mlar:"
echo "  1. Frontend'i baÅŸlat:"
echo "     cd frontend && npm run dev"
echo ""
echo "  2. TarayÄ±cÄ±da aÃ§:"
echo "     http://localhost:5173"
echo ""
echo "  3. Walrus'a deploy et:"
echo "     npm run build"
echo "     site-builder deploy ./dist --epochs 1"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
